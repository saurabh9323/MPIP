name: Deploy MPIP (Folder-wise)

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      # ---------- Detect changes ----------
      - name: Detect changed folders
        id: changes
        run: |
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)

          echo "$CHANGED_FILES"

          echo "frontend=$(echo "$CHANGED_FILES" | grep -q '^frontend/' && echo true || echo false)" >> $GITHUB_OUTPUT
          echo "gateway=$(echo "$CHANGED_FILES" | grep -q '^backend/gateway/' && echo true || echo false)" >> $GITHUB_OUTPUT
          echo "nodeapi=$(echo "$CHANGED_FILES" | grep -q '^backend/node-api/' && echo true || echo false)" >> $GITHUB_OUTPUT

      # ---------- Setup SSH ----------
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY_B64 }}" | base64 -d > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts

      # ---------- Pull latest code ----------
      - name: Pull latest code
        run: |
          ssh ubuntu@${{ secrets.SERVER_IP }} << 'EOF'
            cd /home/ubuntu/projects/dev/MPIP
            git pull origin main
          EOF

      # ---------- Frontend ----------
      - name: Deploy Frontend
        if: steps.changes.outputs.frontend == 'true'
        run: |
          ssh ubuntu@${{ secrets.SERVER_IP }} << 'EOF'
            export NODE_HOME=/home/ubuntu/.nvm/versions/node/v24.12.0
            export PATH=$NODE_HOME/bin:$PATH

            cd /home/ubuntu/projects/dev/MPIP/frontend
            npm install
            npm run build
            pm2 restart mpip-frontend
          EOF

      # ---------- Gateway ----------
      - name: Deploy Gateway
        if: steps.changes.outputs.gateway == 'true'
        run: |
          ssh ubuntu@${{ secrets.SERVER_IP }} << 'EOF'
            export NODE_HOME=/home/ubuntu/.nvm/versions/node/v24.12.0
            export PATH=$NODE_HOME/bin:$PATH

            cd /home/ubuntu/projects/dev/MPIP/backend/gateway
            npm install
            pm2 restart mpip-gateway
          EOF

      # ---------- Node API ----------
      - name: Deploy Node API
        if: steps.changes.outputs.nodeapi == 'true'
        run: |
          ssh ubuntu@${{ secrets.SERVER_IP }} << 'EOF'
            export NODE_HOME=/home/ubuntu/.nvm/versions/node/v24.12.0
            export PATH=$NODE_HOME/bin:$PATH

            cd /home/ubuntu/projects/dev/MPIP/backend/node-api
            npm install
            pm2 restart mpip-node-api
          EOF
